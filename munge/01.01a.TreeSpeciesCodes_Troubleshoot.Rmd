---
title: "TroubleShooting Tree Species Codes"
author: "Nicole Barker"
date: "Last run: Nov 29, 2017"
output: 
  word_document:
    reference_docx: ../styles/ReportFormat_1.docx
---

I discovered early on that different files have different Tree Species codes have different labels in (e.g., Forsite's VRI shapefile, the matrix I received from Kari, and the Ranking Matrix ReadMe where I got my descriptions from).

This report and the embedded scripts show how I identified the problems and the steps I took to standardize them. 

The actual standardization of codes is done in a separate script: 01.01b.TreeSpeciesCodes_Fix.Rmd

``` {r setup, echo=F, message=F, warning=F}
require(knitr)
opts_knit$set(root.dir = '..')
```

# What files do I have that include tree species group codes? 

1. **area_summary_with_matrix.xlsx**: File received from Kari on Dec 1, 2016. Matrix format, contains ranks on one tab and forest areas on another tab.  **As of March 2017, we discard this file because it contains inaccurate information**
2. **BBS_BAM_Atlas_MigLayer_Jan22_2017.csv**: Received from Trish Jan 22, 2017. Intersected the VRI with the new points Trish got from Atlas and other data sources. Reflects species codes from VRI file, though may miss some if they didn't intersect the points. 
3. **mig_birds_Layer_polyarea_forstandatts.RData**: Export of the Jan 2017 Forsite file. With a field I added calculating area (in ha) of each polygon
4. **Migratory_bird_ranking_matrix_V1.3_Apr15_2016 FINAL.xlsx**: Received August 15, 2016 from Kari. Another form of the matrix -- Work done in Feb 2017 showed that the ranks in this file are DIFFERENT from those in file #1, above. I use this file to assign ranks to forest stands, where applicable.
5. Email from Cam Brown listing the codes used in the Forsite GIS analysis. I don't have a separate table for them, but they're in the lookup table. These also match those in the VRI shapefile. 
6. **Stand_Ranking_Matrix_MBNestDensity_README_V1.3_Apr2016.docx**: Received August 15, 2016 from Kari. Text describing the matrix -- work done in Nov 2016 showed that the species groups are not defined the same way as in the matrix and the VRI shapefile.
7. **

# Creating a master file of tree species codes. 

### Step: Load each file and save species codes to a vector. 

#### 1. **area_summary_with_matrix.xlsx**:
``` {r}
df.area_summary_with_matrix <- read.csv("data/COFI.Layer.TableExport/area_summary_with_matrix.csv")
area_summary_with_matrix <- sort(as.character(unique(df.area_summary_with_matrix$X)))
```

####2. BBS_BAM_Atlas_MigLayer_Jan22_2017.csv
``` {r}
df.FORID_BAMv4_Nov29 <- read.csv("data/Intersections/FORID_BAMv4_Nov29.csv")
FORID_BAMv4_Nov29 <- sort(as.character(unique(df.FORID_BAMv4_Nov29$SpeciesGroup)))

df.BAMnew <- read.csv("data/Intersections/BAMv4_identMigLayernew.csv")
BAMnew <- sort(as.character(unique(df.BAMnew$SpeciesGroup)))

df.BBSnew <- read.csv("data/Intersections/BBSv3_IdentMigBirdNew.csv")
BBSnew <- sort(as.character(unique(df.BBSnew$SpeciesGroup)))

df.BAMpts <- read.csv("data/Intersections/BBS_BAM_Atlas_MigLayer_Jan22_2017.csv")
BAMptsnew <- sort(as.character(unique(df.BAMpts$SpeciesGroup)))
```

####3. mig_birds_Layer_polyarea_forstandatts.RData
``` {r}
load("cache/mig_birds_Layer_polyarea_forstandatts.RData")
vri <- mig_birds_Layer_polyarea_forstandatts; rm(mig_birds_Layer_polyarea_forstandatts)

vri_codes <- sort(as.character(unique(vri$SpeciesGroup)))
```

####4 Migratory_bird_ranking_matrix_V1.3_Apr15_2016 FINAL.xlsx
``` {r}
matrixstr <- read.csv("data/COFI.Layer.TableExport/Migratory_bird_ranking_matrix_V1.3_Apr15_2016 FINAL-dataformat.csv")
kari_codes <- sort(as.character(unique(matrixstr$SP_Group)))
```

####5. Cam Brown report
``` {r}
forrpt <- read.csv("BackGround Info/ForsiteProjectReport_SpeciesCodes.csv", header=T)
forsite_codes <- sort(as.character(unique(forrpt$Code)))
```

####6. Stand_Ranking_Matrix_MBNestDensity_README_V1.3_Apr2016.docx
``` {r}
df.README_V1.3_Apr2016_TreeSpeciesCodes <- read.csv("data/COFI.Layer.TableExport/Stand_Ranking_Matrix_MBNestDensity_README_V1.3_Apr2016_TreeSpeciesCodes.csv")
README_V1.3_Apr2016_TreeSpeciesCodes <- sort(as.character(unique(df.README_V1.3_Apr2016_TreeSpeciesCodes$Code)))
```

### Step: Create dataframes of the various species codes, assigned to each file. 

``` {r}
df <- data.frame(file=c(rep("area_summary_with_matrix", times=length(area_summary_with_matrix)),
                        rep("BBS_BAM_Atlas_MigLayer_Jan22_2017", times=length(BAMptsnew)),
                        rep("mig_birds_Layer_polyarea_forstandatts", times=length(vri_codes)),
                        rep("Migratory_bird_ranking_matrix_V1.3_Apr15_2016_ FINAL", times=length(kari_codes)),
                        rep("Forsite project report from Cam Brown", times=length(forsite_codes)),
                        rep("Stand_Ranking_Matrix_MBNestDensity_README_V1.3_Apr2016", times=length(README_V1.3_Apr2016_TreeSpeciesCodes))),
                 code=c(area_summary_with_matrix, BAMptsnew, vri_codes, kari_codes, forsite_codes, README_V1.3_Apr2016_TreeSpeciesCodes))
               
write.table(df, file="data/COFI.Layer.TableExport/TreeSpeciesCodesLegend_format2.csv", row.names=F, col.names=T, sep=",")
```

### Step: Fix codes manually

Manually, open up TreeSpeciesCodesLegend_format2 and create a new column ("code.use"). Fill in the tree species code I should use for each of the codes in the other columns. Save as `LOOKUP.TreeSpeciesCodes.csv`

Here is the resulting file. 

``` {r}
rm(list=ls())
lookup.spcd <- read.csv("data/COFI.Layer.TableExport/LOOKUP.TreeSpeciesCodes.csv", header=T)
kable(lookup.spcd)
```
