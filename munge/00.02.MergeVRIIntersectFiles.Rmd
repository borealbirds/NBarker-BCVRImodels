---
title: "00.02.VRIIntersectFiles"
author: "Nicole Barker"
date: "Last run: Dec 12, 2017"
output: 
  word_document:
    reference_docx: ../styles/ReportFormat_1.docx
---

## Background
On Nov 28, 2017, Trish sent me intersections between the latest avian data and the BC VRI dataset. 

**FILES**

1. bc_atlas_ident.csv
2. BC_CanforTFLvri_bampointsIdent.csv
3. BC_CanforTFLvri_WSI.csv
4. bcBAM_noAtlas_ident.csv
5. bcbbs_ident.csv
6. bcwsi_ident.csv

In this script, I: 

* Inspect each file independently for duplicates
* 

``` {r setup, echo=F, message=F, warning=F}
require(knitr)
opts_knit$set(root.dir = '..')
```

``` {r load.project, message=F}
require(ProjectTemplate)
load.project()
options(digits=12)
```

### Load datasets and look for duplicates among intersected datasets

#### First look for duplicates within datasets

##### 1. bc_atlas_ident.csv

Intersection of the Atlas (BCCA) points with Forsite's "mig bird layer". Their modified version of the VRI dataset with modified BecZone, SpeciesGroup, Age, Height, and Rank fields. 

``` {r}
atlas <- read.csv("data/bc_atlas_ident.csv", header=T)
colnames(atlas)[1:10]
atlas.sm <- atlas[c("FID_BC_BCCA_SelectedMigLayer", "PCODE", "SS", "FID_migratory_bird")]
```

Which SS are duplicated within datasets? 

``` {r}
kable(atlas.sm[atlas.sm$SS %in% atlas.sm$SS[duplicated(atlas.sm$SS)],], row.names=F)
```

**NOTES**

* Looking at these duplicated sites individually, I noticed that they are each on the border between two VRI polygons. They will therefore be omitted from the analyses anyway at a later stage, so I won't worry about them now. 

![ ^^^ Image. Example for SS: BCCA.10CD98.308195](../output/BCCA.10CD98.308195.jpg)

##### 2. BC_CanforTFLvri_bampointsIdent.csv

Intersection of BAM points (Version 4 of the Avian Database) with VRI data from Canfor's TFL. It doesn't have new variables for BecZone, SpeciesGroup, Age, Height, and therefore doesn't have Rank. 

``` {r}
canfortfl <- read.csv("data/BC_CanforTFLvri_bampointsIdent.csv", header=T)
colnames(canfortfl)[1:15]
canfortfl.sm <- canfortfl[c("FID_XYBC_Natv4_TFLCanfor", "PCODE", "SS", "FID_Canfor_TFL_VRI")]
```

Which SS are duplicated within datasets? 

``` {r}
kable(canfortfl.sm[canfortfl.sm$SS %in% canfortfl.sm$SS[duplicated(canfortfl.sm$SS)],], row.names=F)
```

**NOTES**

* No SS duplicated


##### 3. BC_CanforTFLvri_WSI.csv

Intersection of new points (from the WSI database) with VRI data from Canfor's TFL. It doesn't have new variables for BecZone, SpeciesGroup, Age, Height, and therefore doesn't have Rank. 

``` {r}
canfortflwsi <- read.csv("data/BC_CanforTFLvri_WSI.csv", header=T)
colnames(canfortflwsi)[1:15]
canfortflwsi.sm <- canfortflwsi[c("FID_XY_WSI_TFLCanfor", "PCODE", "SS", "FID_Canfor_TFL_VRI")]
```

Which SS are duplicated within datasets? 

``` {r}
kable(canfortflwsi.sm[canfortflwsi.sm$SS %in% canfortflwsi.sm$SS[duplicated(canfortflwsi.sm$SS)],], row.names=F)
```

**NOTES**

* No SS duplicated

##### 4. bcBAM_noAtlas_ident.csv

Intersection of BAM points (Version 4 of the Avian Database) with Forsite's "mig bird layer". Their modified version of the VRI dataset with modified BecZone, SpeciesGroup, Age, Height, and Rank fields. 

``` {r}
bam <- read.csv("data/bcBAM_noAtlas_ident.csv", header=T)
colnames(bam)[1:18]
bam.sm <- bam[c("FID_BCdatanat4", "PCODE", "SS", "FID_migratory_bird")]
```

Which SS are duplicated within datasets? 

``` {r}
kable(bam.sm[bam.sm$SS %in% bam.sm$SS[duplicated(bam.sm$SS)],], row.names=F)
```

**NOTES**

* No SS duplicated

##### 5. bcbbs_ident.csv

Intersection of BBS data with Forsite's "mig bird layer". Their modified version of the VRI dataset with modified BecZone, SpeciesGroup, Age, Height, and Rank fields. 

``` {r}
bbs <- read.csv("data/bcbbs_ident.csv", header=T)
colnames(bbs)[1:18]
bbs.sm <- bbs[c("FID_XYBC_BBS_v3", "PCODE", "SS", "FID_migratory_bird")]
```

Which SS are duplicated within datasets? 

``` {r}
kable(bbs.sm[bbs.sm$SS %in% bbs.sm$SS[duplicated(bbs.sm$SS)],], row.names=F)
```

**NOTES**

* No SS duplicated

##### 6. bcwsi_ident.csv

Intersection of new points (from the WSI database) with Forsite's "mig bird layer". Their modified version of the VRI dataset with modified BecZone, SpeciesGroup, Age, Height, and Rank fields. 

``` {r}
wsi <- read.csv("data/bcwsi_ident.csv", header=T)
colnames(wsi)[1:15]
wsi.sm <- wsi[c("FID_BAMNATV4BConly", "PCODE", "SS", "FID_migratory_bird")]
```

Which SS are duplicated within datasets? 

``` {r}
kable(wsi.sm[wsi.sm$SS %in% wsi.sm$SS[duplicated(wsi.sm$SS)],], row.names=F)
```

**NOTES**

* No SS duplicated

#### Next look for duplicates among datasets (i.e. after combining together)

What are the various column names? 

``` {r}
all.dat.l <- list(atlas.sm, bam.sm, bbs.sm, canfortfl.sm, canfortflwsi.sm, wsi.sm)
kable(as.data.frame(do.call(rbind,lapply(all.dat.l, colnames))))
```

What are the possible duplication scenarios? 

* SS duplicated and intersected FID is the same: suggests the SS was represented in multiple of the avian datasets and intersected with the same VRI dataset twice
* SS duplicated but intersected FID is different: same SS was intersected with multiple polygons (e.g., from different VRI shapefiles)
* FID duplicated for different SS: multiple survey stations intersected the same polygon
* Need to also check for possibility that FIDs are different for the same polygons b/c they're represented in different shapefile layers. Perhaps I need to use a different column as the polygon ID.

##### Combine datasets intersecting Canfor dataset

``` {r combine.canfortfl.datasets}
colnames(canfortfl.sm)[1]    <- "FID_BIRD"
colnames(canfortflwsi.sm)[1] <- "FID_BIRD"

canfordat <- rbind(canfortfl.sm, canfortflwsi.sm)

sum(duplicated(canfordat$SS))
```

**NOTES**

* No duplicated SS here. 

##### Combine datasets intersecting Forsite dataset

``` {r combine.forsite.datasets}
colnames(atlas.sm)[1] <- "FID_BIRD"
colnames(bam.sm)[1]   <- "FID_BIRD"
colnames(bbs.sm)[1]   <- "FID_BIRD"
colnames(wsi.sm)[1]   <- "FID_BIRD"

forsitedat <- rbind(atlas.sm, bam.sm, bbs.sm, wsi.sm)

sum(duplicated(forsitedat$SS))
kable(forsitedat[forsitedat$SS %in% forsitedat$SS[duplicated(forsitedat$SS)],], row.names=F)
```

**NOTES**

* Same 3 duplicates as before. 

##### Combine Canfor TFL & Forsite datasets

``` {r combine.all.datasets}
colnames(canfordat)[4] <- "FID_VRI"
colnames(forsitedat)[4] <- "FID_VRI"
alldat <- rbind(canfordat, forsitedat)

sum(duplicated(alldat$SS))
dupSS <- alldat$SS[duplicated(alldat$SS)]

kable(canfordat[canfordat$SS %in% dupSS[10:30],], row.names=F)
kable(forsitedat[forsitedat$SS %in% dupSS[10:30],], row.names=F)
```

Which PCODEs are represented in the duplicated SS?

``` {r}
sort(as.character(unique(alldat$PCODE[which(alldat$SS %in% dupSS)])))
```

**BCCA**
``` {r}
kable(alldat[alldat$SS %in% dupSS & alldat$PCODE %in% "BCCA",], row.names=F)
```

* BCCA: 3 SS duplicated. Same three I expected before. 

**BL2TFL48**
``` {r}
kable(rbind(head(alldat[alldat$SS %in% dupSS & alldat$PCODE %in% "BL2TFL48",], 10),
            tail(alldat[alldat$SS %in% dupSS & alldat$PCODE %in% "BL2TFL48",], 10)), row.names=F)
```

![ ^^^ Image. Example for PCODE BL2TFL48](../output/BL2TFL48.jpg)

* BL2TFL48: For several of these SS, stations intersect polygons in Forsite's shapefile that are missing key information, such as SpeciesGroup, resulting in NULL RANK.
    * ACTION: Choose CanforTFL intersection for these. Identify them by looking for a null value in either SPECIES_CD_1, BEC_ZONE_CODE, PROJ_AGE_1, or PROJ_HEIGHT_1.

**CF**
``` {r}
kable(rbind(head(alldat[alldat$SS %in% dupSS & alldat$PCODE %in% "CF",], 10),
            tail(alldat[alldat$SS %in% dupSS & alldat$PCODE %in% "CF",], 10)), row.names=F)
```

![ ^^^ Image. Example for SS CF.Murray.38 ](../output/CF.Murray.38.jpg)

* CF: For several of the PCODE CF SS, stations are are intersecting polygons in Forsite's shapefile that are missing key information, such as SpeciesGroup, resulting in NULL RANK.
    * ACTION: Choose CanforTFL intersection for these. Identify them by looking for a null value in either SPECIES_CD_1, BEC_ZONE_CODE, PROJ_AGE_1, or PROJ_HEIGHT_1.


**CW**
``` {r}
kable(rbind(head(alldat[alldat$SS %in% dupSS & alldat$PCODE %in% "CF",], 10),
            tail(alldat[alldat$SS %in% dupSS & alldat$PCODE %in% "CF",], 10)), row.names=F)
```

* CW: Same as for CF and BL2TFL48: stations intersect polygons in Forsite's shapefile that are missing key information, such as SpeciesGroup, resulting in NULL RANK.
    * ACTION: Choose CanforTFL intersection for these. Identify them by looking for a null value in either SPECIES_CD_1, BEC_ZONE_CODE, PROJ_AGE_1, or PROJ_HEIGHT_1.


**TFL48VM**
``` {r}
kable(rbind(head(alldat[alldat$SS %in% dupSS & alldat$PCODE %in% "TFL48VM",], 10),
            tail(alldat[alldat$SS %in% dupSS & alldat$PCODE %in% "TFL48VM",], 10)), row.names=F)
```

* TFL48VM: Same as for CW, CF, and BL2TFL48: stations intersect polygons in Forsite's shapefile that are missing key information, such as SpeciesGroup, resulting in NULL RANK.
    * ACTION: Choose CanforTFL intersection for these. Identify them by looking for a null value in either SPECIES_CD_1, BEC_ZONE_CODE, PROJ_AGE_1, or PROJ_HEIGHT_1.



