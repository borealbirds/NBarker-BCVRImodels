---
title: "PreProcess VRI Data"
author: "Nicole Barker"
date: "Last run: Dec 20, 2017"
output: 
  word_document:
    reference_docx: ../styles/ReportFormat_1.docx
---

``` {r setup, echo=F, message=F, warning=F}
require(knitr)
opts_knit$set(root.dir = '..')
```

``` {r load.project, message=F}
require(ProjectTemplate)
load.project()
options(digits=12)
```

## Pre-process vri file

In this script, I: 

* Convert date columns to date format 
* Pull year out from date
* Classify stands to a stand age class if not already done
* Create two files for future use 
    * one for analyses using Kari/Forsite's 4 derived attributes (will exclude Canfor TFL); and
    * one for density models (using variables from VRI directly, not derived)

### Date pre-processing

``` {r, warning=F, message=F}
vri_intersect <- read.csv("data/VRIintersect_preprocess1.csv", header=T)

F.convertdate.extractyear <- function(x){
  dates <- as.Date(unlist(lapply(strsplit(as.character(x), " "), function(y) {y[1]})), format="%m/%d/%Y")
  years <- format(dates,'%Y')
}

vri_intersect$InputYear <- F.convertdate.extractyear(vri_intersect$INPUT_DATE)
vri_intersect$ProjectedYear <- F.convertdate.extractyear(vri_intersect$PROJECTED_DATE)
vri_intersect$InterpretYear <- F.convertdate.extractyear(vri_intersect$INTERPRETATION_DATE)
vri_intersect$ReferenceYear <- F.convertdate.extractyear(vri_intersect$REFERENCE_DATE)
vri_intersect$AttributionYear <- F.convertdate.extractyear(vri_intersect$ATTRIBUTION_BASE_DATE)
vri_intersect$DistYear_Nonlog <- F.convertdate.extractyear(vri_intersect$EARLIEST_NONLOGGING_DIST_DATE)
vri_intersect$DistYear_Log <- F.convertdate.extractyear(vri_intersect$HARVEST_DATE)
vri_intersect$DisturbanceYear <- apply(vri_intersect[c("DistYear_Nonlog", "DistYear_Log")], MARGIN=1, FUN=function(x) {max(x, na.rm=T)}) 
```

### Stand Age classification

``` {r}
ageclassbreaks <- c(0, 3, 30, 80, 120, 250, 1000)
vri_intersect$AgeClass_calc <- cut(vri_intersect$PROJ_AGE_1, breaks = ageclassbreaks, include.lowest = TRUE, labels = c("0-3 yrs", "3-30 yrs", "31-80 yrs", "81-120 yrs", "121-250 yrs", ">250 yrs"))

kable(rbind(head(vri_intersect[c("PROJ_AGE_1", "AgeClass_calc")]),
            tail(vri_intersect[c("PROJ_AGE_1", "AgeClass_calc")])))
```

### Stand Height classification

``` {r}
heightclassbreaks <- c(0, 10.5, 19.5, 28.5, 100)
vri_intersect$HeightClass_calc <- cut(vri_intersect$PROJ_HEIGHT_1, breaks = heightclassbreaks, include.lowest = TRUE, labels = c("<10.5 m", "10.5-19.4 m", "19.5-28.4 m", "> 28.5 m"))

kable(rbind(head(vri_intersect[c("PROJ_HEIGHT_1", "HeightClass_calc")]),
            tail(vri_intersect[c("PROJ_HEIGHT_1", "HeightClass_calc")])))
```


### Save file for future use

``` {r}
cache("vri_intersect")
```
